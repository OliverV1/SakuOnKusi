---
- name: Firewall permanent DNS
  ansible.posix.firewalld:
    permanent: yes
    service: dns
    state: enabled

- name: Firewall open ports
  ansible.posix.firewalld:
    permanent: yes
    port: "{{ item }}"
    immediate: yes
    state: enabled
  loop:
    - 8301/udp
    - 8301/tcp
    - 53/udp
    - 53/tcp
    

- name: Disable IPv6
  copy:
    src: 70-ipv6.conf
    dest: /etc/sysctl.d/70-ipv6.conf
    owner: root
    group: root
    mode: '0644'


- name: Inserts into hostname
  template:
    src: hostname.j2
    dest: /etc/hostname
    owner: root
    group: root
    mode: '0644'


- name: Inserts into hosts
  template:
    src: hosts.j2
    dest: /etc/hosts
    owner: root
    group: root
    mode: '0644'
  tags:
    - dns

- name: Install Bind9 server
  dnf:
    name:
      - bind
      - bind-utils

- name: Create directory /var/named
  file:
    path: /var/named
    state: directory
    owner: named
    group: named

- name: Create log folder
  file:
    state: directory
    path: /var/named/log
    group: named
    owner: root
    mode: 0775


- name: Create log files
  copy:
    content: ""
    dest: /var/named/log/{{item.name}}
    force: no
    owner: named
    group: named
    mode: 0640
  loop:
    - name: default
    - name: auth_servers
    - name: zone_transfers
    - name: client_security
    - name: queries
    - name: query-errors

- name: replace /etc/named.conf.j2 file with correct conf
  template:
    src: named.conf.j2
    dest: /etc/named.conf
    backup: yes

- name: change nameserver ip in resolv
  copy:
    content: |
      nameserver 127.0.0.1
      search {{ hostname }}.{{ domain_name }}
    dest: /etc/resolv.conf

- name: enable auto-staring the "named" service
  shell: systemctl enable named

- name: create Zone file to /etc/named
  template:
    src: zone.j2
    dest: /etc/named/{{ hostname }}.{{ domain_name }}
    owner: named
    group: named
    mode: 0777

- name: create Reverse Zone file to /etc/named
  template:
    src: zone.reverse.j2
    dest: /etc/named/reverse.{{ hostname }}.{{ domain_name }}
    owner: named
    group: named
    mode: 0777

- name: "get unix time"
  shell: echo $(date +%s)
  register: unix_time_stamp
  delegate_to: localhost
  run_once: true
  become: no

- name: "update zone serial"
  set_fact:
    __bind9_zone_serial: "{{ unix_time_stamp.stdout }}"
  run_once: true
  become: no

- name: restart DNS
  service:
    name: named
    state: reloaded
    enabled: yes
